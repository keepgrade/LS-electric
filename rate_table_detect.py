# ğŸ“¦ ëª¨ë“ˆ ì„í¬íŠ¸
import pandas as pd
from datetime import datetime
import matplotlib.pyplot as plt

# ğŸ“‚ 1. ë°ì´í„° ë¡œë“œ
train_df = pd.read_csv("data/train.csv")
train_df['ì¸¡ì •ì¼ì‹œ'] = pd.to_datetime(train_df['ì¸¡ì •ì¼ì‹œ'])

# ğŸ•’ 2. ê³„ì ˆ/ì‹œê°„ëŒ€ íŒŒìƒ ë³€ìˆ˜ ìƒì„±

def get_season(month):
    if month in [6, 7, 8]: return 'ì—¬ë¦„'
    elif month in [3, 4, 5, 9, 10]: return 'ë´„ê°€ì„'
    else: return 'ê²¨ìš¸'

def get_time_zone(hour, month):
    season = get_season(month)
    if season in ['ì—¬ë¦„', 'ë´„ê°€ì„']:
        if 22 <= hour or hour < 8:
            return 'ê²½ë¶€í•˜'
        elif (8 <= hour < 11) or (12 <= hour < 13) or (18 <= hour < 22):
            return 'ì¤‘ê°„ë¶€í•˜'
        else:
            return 'ìµœëŒ€ë¶€í•˜'
    else:
        if 22 <= hour or hour < 8:
            return 'ê²½ë¶€í•˜'
        elif (8 <= hour < 9) or (12 <= hour < 16) or (19 <= hour < 22):
            return 'ì¤‘ê°„ë¶€í•˜'
        else:
            return 'ìµœëŒ€ë¶€í•˜'

train_df['ì›”'] = train_df['ì¸¡ì •ì¼ì‹œ'].dt.month
train_df['ì‹œê°„'] = train_df['ì¸¡ì •ì¼ì‹œ'].dt.hour
train_df['ê³„ì ˆ'] = train_df['ì›”'].apply(get_season)
train_df['ì‹œê°„ëŒ€'] = train_df.apply(lambda row: get_time_zone(row['ì‹œê°„'], row['ì›”']), axis=1)

# ğŸ“Š 3. ì „ì²´ ìš”ê¸ˆì œ ë‹¨ê°€ í…Œì´ë¸” (ê³ ì••A/B/C ì„ íƒâ… /â…¡/â…¢ ê°ê° before/after í¬í•¨ ì´ 18ê°œ)
rate_tables = {}
groups = ['ê³ ì••A', 'ê³ ì••B', 'ê³ ì••C']
choices = ['ì„ íƒ1', 'ì„ íƒ2', 'ì„ íƒ3']
times = ['before', 'after']

rates = {
    'ê³ ì••A': {
        'ì„ íƒ1': {'before': {'ì—¬ë¦„': [99.5, 152.4, 234.5], 'ë´„ê°€ì„': [99.5, 122.0, 152.7], 'ê²¨ìš¸': [106.5, 152.6, 210.1]},
                  'after':  {'ì—¬ë¦„': [116.4, 169.3, 251.4], 'ë´„ê°€ì„': [116.4, 138.9, 169.6], 'ê²¨ìš¸': [123.4, 169.5, 227.0]}},
        'ì„ íƒ2': {'before': {'ì—¬ë¦„': [94.0, 146.9, 229.0], 'ë´„ê°€ì„': [94.0, 116.5, 147.2], 'ê²¨ìš¸': [101.0, 147.1, 204.6]},
                  'after':  {'ì—¬ë¦„': [110.9, 163.8, 245.9], 'ë´„ê°€ì„': [110.9, 133.4, 164.1], 'ê²¨ìš¸': [117.9, 164.0, 221.5]}},
        'ì„ íƒ3': {'before': {'ì—¬ë¦„': [93.1, 146.3, 216.6], 'ë´„ê°€ì„': [93.1, 115.2, 138.9], 'ê²¨ìš¸': [100.4, 146.5, 193.4]},
                  'after':  {'ì—¬ë¦„': [110.0, 163.2, 233.5], 'ë´„ê°€ì„': [110.0, 132.1, 155.8], 'ê²¨ìš¸': [117.3, 163.4, 210.3]}}
    },
    'ê³ ì••B': {
        'ì„ íƒ1': {'before': {'ì—¬ë¦„': [109.4, 161.7, 242.9], 'ë´„ê°€ì„': [109.4, 131.7, 162.0], 'ê²¨ìš¸': [116.4, 161.7, 217.9]},
                  'after':  {'ì—¬ë¦„': [126.3, 178.6, 259.8], 'ë´„ê°€ì„': [126.3, 148.6, 178.9], 'ê²¨ìš¸': [133.3, 178.6, 234.8]}},
        'ì„ íƒ2': {'before': {'ì—¬ë¦„': [105.6, 157.9, 239.1], 'ë´„ê°€ì„': [105.6, 127.9, 158.2], 'ê²¨ìš¸': [112.6, 157.9, 214.1]},
                  'after':  {'ì—¬ë¦„': [122.5, 174.8, 256.0], 'ë´„ê°€ì„': [122.5, 144.8, 175.1], 'ê²¨ìš¸': [129.5, 174.8, 231.0]}},
        'ì„ íƒ3': {'before': {'ì—¬ë¦„': [103.9, 156.2, 237.5], 'ë´„ê°€ì„': [103.9, 126.3, 156.6], 'ê²¨ìš¸': [111.0, 156.2, 212.4]},
                  'after':  {'ì—¬ë¦„': [120.8, 173.1, 254.4], 'ë´„ê°€ì„': [120.8, 143.2, 173.5], 'ê²¨ìš¸': [127.9, 173.1, 229.3]}}
    },
    'ê³ ì••C': {
        'ì„ íƒ1': {'before': {'ì—¬ë¦„': [108.9, 161.8, 242.7], 'ë´„ê°€ì„': [108.9, 131.8, 162.2], 'ê²¨ìš¸': [115.8, 161.4, 218.0]},
                  'after':  {'ì—¬ë¦„': [125.8, 178.7, 259.6], 'ë´„ê°€ì„': [125.8, 148.7, 179.1], 'ê²¨ìš¸': [132.7, 178.3, 234.9]}},
        'ì„ íƒ2': {'before': {'ì—¬ë¦„': [104.2, 157.1, 238.0], 'ë´„ê°€ì„': [104.2, 127.1, 157.5], 'ê²¨ìš¸': [111.1, 156.7, 213.3]},
                  'after':  {'ì—¬ë¦„': [121.1, 174.0, 254.9], 'ë´„ê°€ì„': [121.1, 144.0, 174.4], 'ê²¨ìš¸': [128.0, 173.6, 230.2]}},
        'ì„ íƒ3': {'before': {'ì—¬ë¦„': [103.1, 156.0, 236.9], 'ë´„ê°€ì„': [103.1, 126.0, 156.4], 'ê²¨ìš¸': [110.0, 155.6, 212.2]},
                  'after':  {'ì—¬ë¦„': [120.0, 172.9, 253.8], 'ë´„ê°€ì„': [120.0, 142.9, 173.3], 'ê²¨ìš¸': [126.9, 172.5, 229.1]}}
    }
}

for group in groups:
    for choice in choices:
        for time in times:
            label = f"{group}_{choice}_{time}"
            rate_tables[label] = {
                season: {tz: rate for tz, rate in zip(['ê²½ë¶€í•˜', 'ì¤‘ê°„ë¶€í•˜', 'ìµœëŒ€ë¶€í•˜'], rates[group][choice][time][season])}
                for season in ['ì—¬ë¦„', 'ë´„ê°€ì„', 'ê²¨ìš¸']
            }

# ğŸ§  4. ì •ì±… ìš”ê¸ˆ ê³„ì‚° ë° ì°¨ì´ ê³„ì‚°
for plan, table in rate_tables.items():
    train_df[f'ì •ì±…ìš”ê¸ˆ_{plan}'] = train_df.apply(
        lambda row: row['ì „ë ¥ì‚¬ìš©ëŸ‰(kWh)'] * table[row['ê³„ì ˆ']][row['ì‹œê°„ëŒ€']], axis=1
    )
    train_df[f'ì°¨ì´_{plan}'] = abs(train_df['ì „ê¸°ìš”ê¸ˆ(ì›)'] - train_df[f'ì •ì±…ìš”ê¸ˆ_{plan}'])

# ğŸ” 5. ê°€ì¥ ìœ ì‚¬í•œ ìš”ê¸ˆì œ ì¶”ì •
policy_cols = [f'ì°¨ì´_{plan}' for plan in rate_tables]
train_df['ì‹¤ì œìš”ê¸ˆ_ìœ ì‚¬ìš”ê¸ˆì œ'] = train_df[policy_cols].idxmin(axis=1).str.replace('ì°¨ì´_', '')

# ğŸ“… 6. ì ìš© ì‹œì  êµ¬ë¶„
cutoff_date = datetime(2024, 10, 24)
train_df['ì ìš©ì‹œì '] = train_df['ì¸¡ì •ì¼ì‹œ'].apply(lambda x: 'before' if x < cutoff_date else 'after')

# ğŸ“Š 7. ë¶„í¬ ë¶„ì„ ë° ì‹œê°í™”
pivot = train_df.groupby(['ì ìš©ì‹œì ', 'ì‹¤ì œìš”ê¸ˆ_ìœ ì‚¬ìš”ê¸ˆì œ']).size().unstack(fill_value=0)
ax = pivot.T.plot(kind='bar', stacked=True, figsize=(12, 6), title='ì‹œì ë³„ ìœ ì‚¬ ìš”ê¸ˆì œ ë¶„í¬')
ax.set_ylabel('ê±´ìˆ˜')
plt.xticks(rotation=45)
plt.tight_layout()
plt.grid(True)
plt.show()
